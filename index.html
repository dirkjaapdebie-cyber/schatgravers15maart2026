<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schatgravers - Olijfberg</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3799; --accent: #eb4d4b; --success: #20bf6b;
            --bg: #0a3d62; --white: #ffffff;
        }

        body, html { margin: 0; padding: 0; height: 100vh; font-family: 'Fredoka', sans-serif; overflow: hidden; background: var(--bg); color: #333; }
        
        .bg-fixed {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(10, 61, 98, 0.85), rgba(10, 61, 98, 0.85)), url('schatgravers15maart.jpg');
            background-size: cover; background-position: center; z-index: -1;
        }

        /* Navigatie Stipjes */
        .nav-dots {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 40px; z-index: 100;
        }
        .dot { width: 12px; height: 12px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: white; transform: scale(1.4); box-shadow: 0 0 10px white; }

        .container { display: none; height: 100vh; padding: 80px 30px 30px; box-sizing: border-box; }

        /* Fase 3 Layout */
        .layout-grid { display: grid; grid-template-columns: 320px 1fr; gap: 20px; height: 100%; }
        .vault-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        
        .vault-box { 
            background: var(--white); border-radius: 15px; padding: 15px; 
            display: flex; flex-direction: column; transition: 0.3s; border: 3px solid transparent;
        }
        .vault-box.active-vault { border-color: var(--primary); box-shadow: 0 0 20px rgba(30, 55, 153, 0.3); }
        .vault-header { font-weight: bold; font-size: 0.8rem; color: var(--primary); margin-bottom: 10px; border-bottom: 1px solid #eee; }
        .vault-list { flex: 1; overflow-y: auto; font-size: 0.9rem; }

        /* Story Overlay */
        #story-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; display: none;
            justify-content: center; align-items: center; padding: 20px;
        }
        .story-content { background: white; width: 100%; max-width: 750px; padding: 40px; border-radius: 15px; line-height: 1.6; }

        /* Knoppen & Input */
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-family: 'Fredoka'; }
        .input-field { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 10px; box-sizing: border-box; font-family: 'Fredoka'; }

        /* Dobbelsteen */
        .dice-wrap { text-align: center; }
        .cube { width: 60px; height: 60px; margin: 15px auto; transform-style: preserve-3d; transition: 1s; }
        .face { position: absolute; width: 60px; height: 60px; background: white; border: 2px solid var(--primary); line-height: 60px; font-size: 24px; font-weight: bold; border-radius: 5px; text-align: center; }

        /* Regie */
        .regie-tools { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 8px; z-index: 3000; }
        .regie-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid white; background: none; color: white; cursor: pointer; font-weight: bold; }
        .regie-btn.active { background: white; color: var(--bg); }

        .item { background: #f8f9fa; padding: 6px 10px; border-radius: 6px; margin-bottom: 5px; border-left: 3px solid var(--primary); }
    </style>
</head>
<body>

<audio id="ping-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
<div class="bg-fixed"></div>

<div class="nav-dots">
    <div class="dot" id="dot-p1"></div>
    <div class="dot" id="dot-p2"></div>
    <div class="dot" id="dot-p3"></div>
</div>

<div id="phase-1" class="container" style="display:flex; justify-content:center; align-items:center;">
    <div class="card" style="width: 350px; text-align: center;">
        <h2 style="margin-top:0;">Aanmelden</h2>
        <input type="text" id="name-in" placeholder="Naam leerling" class="input-field">
        <button onclick="sendName()" class="btn">DEELNEMEN</button>
    </div>
</div>

<div id="phase-2" class="container" style="display:flex; justify-content:center; align-items:center;">
    <div class="card" style="text-align: center; width: 450px;">
        <h1 id="timer-display" style="font-size: 3.5rem; margin: 0; color: var(--accent);">01:30</h1>
        <p>Verken de omgeving van de Olijfberg.</p>
        <a href="https://earth.google.com/web/search/Mount+of+Olives,+Jerusalem" target="_blank" class="btn" style="text-decoration:none; display:block;">OPEN GOOGLE EARTH</a>
    </div>
</div>

<div id="phase-3" class="container">
    <div class="layout-grid">
        <div class="sidebar-controls">
            <div class="card dice-wrap">
                <div class="cube" id="cube">
                    <div class="face" style="transform:rotateY(0deg) translateZ(30px)">1</div>
                    <div class="face" style="transform:rotateY(180deg) translateZ(30px)">2</div>
                    <div class="face" style="transform:rotateY(-90deg) translateZ(30px)">3</div>
                    <div class="face" style="transform:rotateY(90deg) translateZ(30px)">4</div>
                    <div class="face" style="transform:rotateX(-90deg) translateZ(30px)">5</div>
                    <div class="face" style="transform:rotateX(90deg) translateZ(30px)">6</div>
                </div>
                <button onclick="triggerRoll()" class="btn">DOBBELEN</button>
                <p id="active-stmt" style="font-size:0.85rem; margin-top:15px; font-weight:600;"></p>
            </div>
            <div class="card" style="margin-top:15px;">
                <input type="text" id="thought-in" placeholder="Antwoord invoeren..." class="input-field">
                <button onclick="sendThought()" class="btn" style="background:var(--success);">VERZENDEN</button>
            </div>
        </div>

        <div class="vault-container">
            <div class="vault-box" id="vault-1"><div class="vault-header">1. ANGST</div><div class="vault-list"></div></div>
            <div class="vault-box" id="vault-2"><div class="vault-header">2. KEUZES</div><div class="vault-list"></div></div>
            <div class="vault-box" id="vault-3"><div class="vault-header">3. ENGELEN</div><div class="vault-list"></div></div>
            <div class="vault-box" id="vault-4"><div class="vault-header">4. BIDDEN</div><div class="vault-list"></div></div>
            <div class="vault-box" id="vault-5"><div class="vault-header">5. ALLEEN</div><div class="vault-list"></div></div>
            <div class="vault-box" id="vault-6"><div class="vault-header">6. HERSTEL</div><div class="vault-list"></div></div>
        </div>
    </div>
</div>

<div id="story-view">
    <div class="story-content">
        <h2 style="margin-top:0;">Het verhaal van de Olijfberg</h2>
        <div id="story-body">
            <p>Jezus ging naar de Olijfberg om te bidden. Hij wist dat er een moeilijke tijd aanbrak en voelde zich angstig. Hij vroeg zijn discipelen om wakker te blijven en met Hem te bidden, maar zij vielen in slaap.</p>
            <p>Hoewel Hij zich alleen voelde, bleef Jezus bidden. Er verscheen een engel uit de hemel die Hem nieuwe kracht gaf voor wat er komen ging.</p>
        </div>
    </div>
</div>

<div class="regie-tools">
    <button class="regie-btn" id="r1" onclick="updatePhase('p1')">1</button>
    <button class="regie-btn" id="r2" onclick="updatePhase('p2')">2</button>
    <button class="regie-btn" id="r3" onclick="updatePhase('p3')">3</button>
    <button class="regie-btn" id="rS" onclick="toggleStory()" style="background:var(--accent); border:none;">ðŸ“–</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBC3Dzm8PNPXw12VJNimvly5u2I93QeW54",
        authDomain: "schatgravers15maart2026.firebaseapp.com",
        projectId: "schatgravers15maart2026",
        databaseURL: "https://schatgravers15maart2026-default-rtdb.europe-west1.firebasedatabase.app",
        appId: "1:30561512857:web:fcb7868b87d292d1c97708"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let timerInterval, currentDiceResult = 1, storyVisible = false;

    const stellingen = ["ANGST", "KEUZES", "ENGELEN", "BIDDEN", "ALLEEN", "HERSTEL"];

    window.updatePhase = (p) => set(ref(db, 'currentPhase'), p);
    window.toggleStory = () => { storyVisible = !storyVisible; set(ref(db, 'storyVisible'), storyVisible); };
    window.sendName = () => { const v = document.getElementById('name-in').value; if(v) push(ref(db, 'names'), v); };
    window.triggerRoll = () => set(ref(db, 'gameState'), {r: Math.floor(Math.random()*6)+1, t: Date.now()});
    window.sendThought = () => { 
        const v = document.getElementById('thought-in').value; 
        if(v) { push(ref(db, 'vaults/' + currentDiceResult), v); document.getElementById('thought-in').value=''; }
    };

    onValue(ref(db, 'currentPhase'), s => {
        const p = s.val() || 'p1';
        document.querySelectorAll('.container').forEach(c => c.style.display = 'none');
        document.getElementById('phase-' + p.replace('p','')).style.display = 'flex';
        document.querySelectorAll('.dot, .regie-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('dot-' + p).classList.add('active');
        document.getElementById('r' + p.replace('p','')).classList.add('active');
        if (p === 'p2') startTimer(); else clearInterval(timerInterval);
    });

    onValue(ref(db, 'storyVisible'), s => {
        const visible = s.val();
        document.getElementById('story-view').style.display = visible ? 'flex' : 'none';
        document.getElementById('rS').classList.toggle('active', visible);
        storyVisible = visible;
    });

    onValue(ref(db, 'gameState'), s => {
        const d = s.val(); if(d) {
            currentDiceResult = d.r;
            const rotations = {1:'rotateY(0deg)', 2:'rotateY(180deg)', 3:'rotateY(-90deg)', 4:'rotateY(90deg)', 5:'rotateX(-90deg)', 6:'rotateX(90deg)'};
            document.getElementById('cube').style.transform = rotations[d.r];
            document.getElementById('active-stmt').innerText = "Huidige thema: " + stellingen[d.r-1];
            document.querySelectorAll('.vault-box').forEach(v => v.classList.remove('active-vault'));
            document.getElementById('vault-' + d.r).classList.add('active-vault');
        }
    });

    onValue(ref(db, 'vaults'), s => {
        const data = s.val(); 
        for(let i=1; i<=6; i++) {
            const list = document.querySelector(`#vault-${i} .vault-list`);
            list.innerHTML = "";
            if(data && data[i]) Object.values(data[i]).forEach(t => {
                list
