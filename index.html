<div class="navigation-panel">
    <button class="nav-btn" id="btn-p1" onclick="navTo('p1')">1</button>
    <button class="nav-btn" id="btn-p2" onclick="navTo('p2')">2</button>
    <button class="nav-btn" id="btn-p3" onclick="navTo('p3')">3</button>
    <button class="nav-btn" id="btn-p4" onclick="navTo('p4')">4</button>
    <button class="nav-btn" id="btn-p5" onclick="navTo('p5')">5</button>
    <button class="nav-btn" id="btn-p6" onclick="navTo('p6')">6</button>
    <button class="nav-btn" style="background:var(--accent); border-color:white; margin-left:5px;" onclick="fullReset()">R</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase configuratie (ongewijzigd)
    const firebaseConfig = { 
        apiKey: "AIzaSyBC3Dzm8PNPXw12VJNimvly5u2I93QeW54", 
        authDomain: "schatgravers15maart2026.firebaseapp.com", 
        databaseURL: "https://schatgravers15maart2026-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "schatgravers15maart2026", 
        appId: "1:30561512857:web:fcb7868b87d292d1c97708" 
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- DE RESET FUNCTIE ---
    window.fullReset = () => {
        if(confirm("LET OP: Dit wist alle namen, antwoorden en voortgang. Wil je echt resetten?")) {
            remove(ref(db)).then(() => {
                set(ref(db, 'currentPhase'), 'p1');
                location.reload(); // Ververst de pagina voor een schone lei
            });
        }
    };

    // --- DE REST VAN DE LOGICA ---
    let curDice = 1, selNameVal = "", selNameEl = null, p2Int, wsInt, timerStarted = false;
    const stellingen = ["1. Ik ben nooit bang.", "2. Soms hoop ik dat een taak niet doorgaat.", "3. Ik sta altijd klaar voor anderen.", "4. Ik bid direct als ik bang ben.", "5. Ik voel me weleens alleen.", "6. Ik doe wat God vraagt."];
    
    const matcherData = [
        {n:"Abraham", g:"Wilt u de stad sparen om 10 rechtvaardigen?", u:"Hij onderhandelde met God om Sodom te redden."},
        {n:"David", g:"Was mij schoon, maak mij witter dan sneeuw.", u:"Dit bad David toen hij spijt had van zijn fouten."},
        {n:"Jezus", g:"Niet mijn wil, maar Uw wil geschiede.", u:"Jezus bad dit op de Olijfberg."},
        {n:"Salomo", g:"Geef mij een hart dat naar U luistert.", u:"Salomo vroeg God om wijsheid."},
        {n:"Hanna", g:"Geef mij een zoon, hij zal U dienen.", u:"Hanna bad vurig om een kind."}
    ];

    window.navTo = (p) => set(ref(db, 'currentPhase'), p);
    window.sendName = () => { const v = document.getElementById('name-in').value; if(v) push(ref(db, 'names'), v); document.getElementById('name-in').value=''; };
    window.sendThought = () => { const v = document.getElementById('thought-in').value; if(v) push(ref(db, 'vaults/'+curDice), v); document.getElementById('thought-in').value=''; };
    window.triggerRoll = () => set(ref(db, 'dice'), Math.floor(Math.random()*6)+1);
    window.closeInfo = () => document.getElementById('info-overlay').style.display = 'none';

    onValue(ref(db, 'currentPhase'), s => {
        const p = s.val() || 'p1';
        document.querySelectorAll('.container').forEach(c => c.style.display = 'none');
        const target = document.getElementById('phase-' + p.replace('p',''));
        if(target) target.style.display = 'flex';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById('btn-'+p); if(btn) btn.classList.add('active');
        if(p==='p2') startP2();
        if(p==='p5') initMatcher();
        if(p==='p6') initWS();
    });

    onValue(ref(db, 'dice'), s => {
        curDice = s.val() || 1;
        document.getElementById('dice-display').innerText = ["⚀","⚁","⚂","⚃","⚄","⚅"][curDice-1];
        document.getElementById('stelling-text').innerText = stellingen[curDice-1];
        document.querySelectorAll('.vault').forEach(v => v.classList.remove('active'));
        const vEl = document.getElementById('v-'+curDice); if(vEl) vEl.classList.add('active');
    });

    onValue(ref(db, 'names'), s => {
        const d = document.getElementById('display-names-list'); d.innerHTML = '';
        if(s.val()) Object.values(s.val()).forEach(n => d.innerHTML += `<span class="name-tag" style="font-size:0.6rem;">${n}</span>`);
    });

    onValue(ref(db, 'vaults'), s => {
        for(let i=1; i<=6; i++){
            const v = document.getElementById('l'+i); if(!v) continue; v.innerHTML = '';
            if(s.val() && s.val()[i]) Object.values(s.val()[i]).slice(-2).forEach(t => v.innerHTML += `<div style="font-size:0.5rem;">• ${t}</div>`);
        }
    });

    function initMatcher() {
        const src = document.getElementById('names-source'); const trg = document.getElementById('prayer-targets');
        src.innerHTML = ''; trg.innerHTML = '';
        [...matcherData].sort(() => Math.random()-0.5).forEach(item => {
            const tag = document.createElement('div'); tag.className = 'name-tag'; tag.innerText = item.n;
            tag.onclick = () => { document.querySelectorAll('.name-tag').forEach(t => t.classList.remove('selected')); tag.classList.add('selected'); selNameVal = item.n; selNameEl = tag; };
            src.appendChild(tag);
        });
        matcherData.forEach(item => {
            const card = document.createElement('div'); card.className = 'prayer-card'; card.innerHTML = `<i>"${item.g}"</i>`;
            card.onclick = () => {
                if(!selNameVal) return;
                if(selNameVal === item.n) {
                    card.innerHTML = `<b>${item.n}</b><br><i>"${item.g}"</i>`; card.classList.add('filled'); selNameEl.classList.add('hidden');
                    document.getElementById('info-title').innerText = item.n; document.getElementById('info-text').innerText = item.u;
                    document.getElementById('info-overlay').style.display = 'flex';
                    confetti({particleCount:40, spread:50}); selNameVal = "";
                } else {
                    card.style.borderColor = "red"; setTimeout(() => card.style.borderColor = "#ccc", 500);
                }
            };
            trg.appendChild(card);
        });
    }

    function initWS() {
        const g = document.getElementById('ws-grid'); const l = document.getElementById('ws-list');
        g.innerHTML = ''; l.innerHTML = '';
        for(let i=0; i<144; i++){
            const div = document.createElement('div'); div.className = 'ws-letter'; div.innerText = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random()*26)];
            div.onclick = () => { div.classList.toggle('found'); if(!timerStarted) startWS(); };
            g.appendChild(div);
        }
        ["OLIJFBERG", "JUDAS", "GEBED", "PASEN", "KRACHT", "BEKER", "ENGEL", "KUS", "PETRUS", "HAAN", "WAKKER", "TUIN", "BLOED", "ZWEET", "HEER"].forEach(w => {
            const i = document.createElement('div'); i.innerText = w; i.onclick = () => i.style.textDecoration='line-through'; l.appendChild(i);
        });
    }

    function startWS() { timerStarted = true; let t = 180; wsInt = setInterval(() => { document.getElementById('ws-timer').innerText = `${Math.floor(t/60)}:${(t%60).toString().padStart(2,'0')}`; if(t-- <= 0) clearInterval(wsInt); }, 1000); }
    window.checkSentence = (v) => { if(v.toLowerCase().trim() === "van u is het koninkrijk") confetti({particleCount:150, spread:70, origin:{y:0.6}}); };
    function startP2() { let t = 90; clearInterval(p2Int); p2Int = setInterval(() => { document.getElementById('timer-p2').innerText = `${Math.floor(t/60)}:${(t%60).toString().padStart(2,'0')}`; if(t-- <= 0) clearInterval(p2Int); }, 1000); }
</script>
